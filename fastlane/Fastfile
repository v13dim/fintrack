# FinTrack - Fastlane configuration (iOS + Android)
# Run from project root: bundle exec fastlane <platform> <lane>
# e.g. bundle exec fastlane android build
#      bundle exec fastlane android distribute
#      bundle exec fastlane ios build

# Project root (parent of fastlane/); needed because Fastlane may run with CWD = fastlane/ in CI
PROJECT_ROOT = File.expand_path('..', File.dirname(__FILE__))

# Firebase App ID (Android) from google-services.json; override with env FIREBASE_APP_ID_ANDROID
FIREBASE_APP_ID_ANDROID = ENV['FIREBASE_APP_ID_ANDROID'] || '1:544730757447:android:12004fc2188098dd113462'

default_platform(:android)

platform :android do
  desc 'Build Android debug APK (CI / local verification)'
  lane :build_debug do
    gradle(
      project_dir: 'android',
      task: 'assembleDebug',
      flags: '--no-daemon'
    )
  end

  desc 'Build Android release AAB (for Play Store / Firebase)'
  lane :build do
    gradle(
      project_dir: 'android',
      task: 'bundleRelease'
    )
  end

  desc 'Build Android releaseDev AAB (CI / Firebase App Distribution)'
  lane :build_release_dev do
    gradle(
      project_dir: 'android',
      task: 'bundleReleaseDev'
    )
  end

  desc 'Build Android release APK'
  lane :build_apk do
    gradle(
      project_dir: 'android',
      task: 'assembleRelease'
    )
  end

  desc 'Upload Android releaseDev to Firebase App Distribution (builds AAB then uploads)'
  lane :distribute do
    build_release_dev
    firebase_app_distribution(
      app: FIREBASE_APP_ID_ANDROID,
      firebase_cli_token: ENV['FIREBASE_CLI_TOKEN'],
      service_credentials_file: ENV['GOOGLE_APPLICATION_CREDENTIALS'],
      android_artifact_type: 'AAB',
      android_artifact_path: File.join(PROJECT_ROOT, 'android', 'app', 'build', 'outputs', 'bundle', 'releaseDev', 'app-releaseDev.aab'),
      release_notes: ENV['FIREBASE_RELEASE_NOTES'] || "FinTrack build #{Time.now.utc.strftime('%Y-%m-%d %H:%M')} UTC",
      testers: ENV['FIREBASE_TESTERS'],
      groups: ENV['FIREBASE_GROUPS'],
      debug: ENV['FIREBASE_DEBUG'] == 'true'
    )
  end
end

platform :ios do
  desc 'Build iOS for simulator (CI / local, no signing)'
  lane :build_simulator do
    ios_dir = File.join(PROJECT_ROOT, 'ios')
    sh("cd '#{ios_dir}' && bundle exec pod install")
    sh(
      "cd '#{ios_dir}' && xcodebuild build " \
      '-workspace fintrack.xcworkspace ' \
      '-scheme fintrack ' \
      '-sdk iphonesimulator ' \
      "-destination 'generic/platform=iOS Simulator' " \
      '-configuration Debug ' \
      'CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO'
    )
  end

  desc 'Build iOS app (requires signing setup for device/TestFlight)'
  lane :build do
    gym(
      workspace: 'ios/fintrack.xcworkspace',
      scheme: 'fintrack',
      export_method: 'development',
      clean: true
    )
  end
end
